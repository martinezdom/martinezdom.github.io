---
import SunIcon from "./icons/Sun.astro";
import MoonIcon from "./icons/Moon.astro";
import SystemIcon from "./icons/System.astro";
import Icon from "./ThemeIcon.astro";
const { language } = Astro.props;

const THEMES = [
  { label: language.themes.light, value: "light", icon: SunIcon },
  { label: language.themes.dark, value: "dark", icon: MoonIcon },
  { label: language.themes.system, value: "system", icon: SystemIcon },
];
---

<div class="fixed bottom-8 right-10">
  <button
    id="theme-toggle-btn"
    aria-expanded="false"
    class="theme-toggle-btn relative rounded-full flex items-center justify-center size-12 border-3 border-gray-900 dark:border-white text-gray-900 dark:text-white bg-white dark:bg-gray-900 hover:bg-gray-900 hover:text-white hover:dark:bg-white hover:dark:text-gray-900 transition-all duration-300 shadow-lg"
  >
    <span class="sr-only">{language.themes.selectorText}</span>
    <Icon id="light">
      <SunIcon />
    </Icon>
    <Icon id="dark">
      <MoonIcon />
    </Icon>
    <Icon id="system">
      <SystemIcon />
    </Icon>
  </button>

  <div
    id="themes-menu"
    class="hidden absolute bottom-full right-0 mb-1.5 flex-col space-y-1.5"
    role="menu"
    aria-labelledby="theme-toggle-btn"
  >
    {
      THEMES.map((theme) => (
        <button
          class="theme-option-btn rounded-full flex items-center justify-center size-12 border-3 border-gray-900 dark:border-white text-gray-900 dark:text-white bg-white dark:bg-gray-900 hover:bg-gray-900 hover:text-white hover:dark:bg-white hover:dark:text-gray-900 transition-all duration-300 shadow-lg"
          data-theme={theme.value}
          role="menuitem"
          aria-label={theme.label}
          title={theme.label}
        >
          <span class="sr-only">{theme.label}</span>
          <Icon id={theme.value}>
            <theme.icon />
          </Icon>
        </button>
      ))
    }
  </div>
</div>

<script is:inline>
  const matchMedia = window.matchMedia("(prefers-color-scheme: dark)");
  const btn = document.getElementById("theme-toggle-btn");
  const menu = document.getElementById("themes-menu");

  const getTheme = () => {
    const stored = localStorage.getItem("theme");
    return stored && ["light", "dark", "system"].includes(stored)
      ? stored
      : "system";
  };

const updateIcon = (theme) => {
  document.querySelectorAll("#theme-toggle-btn .theme-toggle-icon").forEach((el) => {
    if (el.id === theme) {
      el.classList.remove("opacity-0");
      el.classList.add("opacity-100");
    } else {
      el.classList.remove("opacity-100");
      el.classList.add("opacity-0");
    }
  });
};

  const applyTheme = () => {
    const theme = getTheme();
    const isDark =
      theme === "dark" || (theme === "system" && matchMedia.matches);
    document.documentElement.classList[isDark ? "add" : "remove"]("dark");
    updateIcon(theme);
  };

  const toggleButtonActiveState = (isActive) => {
    if (isActive) {
      btn.classList.add("bg-gray-900", "text-white", "dark:bg-white", "dark:text-gray-900");
      btn.classList.remove("bg-white", "text-gray-900", "dark:bg-gray-900", "dark:text-white");
    } else {
      // Estado normal
      btn.classList.add("bg-white", "text-gray-900", "dark:bg-gray-900", "dark:text-white");
      btn.classList.remove("bg-gray-900", "text-white", "dark:bg-white", "dark:text-gray-900");
    }
  };

  applyTheme();

  matchMedia.addEventListener("change", applyTheme);

  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    const isExpanded = btn.getAttribute("aria-expanded") === "true";
    menu.classList.toggle("hidden", isExpanded);
    btn.setAttribute("aria-expanded", !isExpanded);
    
    toggleButtonActiveState(!isExpanded);
  });

  document.addEventListener("click", (e) => {
    if (!btn.contains(e.target) && !menu.contains(e.target)) {
      menu.classList.add("hidden");
      btn.setAttribute("aria-expanded", "false");
      toggleButtonActiveState(false);
    }
  });

  document.querySelectorAll(".theme-option-btn").forEach((el) => {
    el.addEventListener("click", (e) => {
      const theme = e.currentTarget.dataset.theme;
      localStorage.setItem("theme", theme);
      applyTheme();
      menu.classList.add("hidden");
      btn.setAttribute("aria-expanded", "false");
      toggleButtonActiveState(false);
    });
  });

  document.addEventListener("astro:after-swap", () => {
    applyTheme();
  });
</script>